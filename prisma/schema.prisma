// Prisma schema for sms-blossom-api
generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "../docs/erd/diagram.svg"
  theme    = "forest"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  male
  female
  unknown
}

model Shop {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  domain       String   @unique
  name         String?
  tokenOffline String? // encrypted offline token (AES-GCM) gcm::<iv_b64>::<tag_b64>::<data_b64>
  // Sprint B: settings & locale for rules
  timezone     String?  // e.g., "Europe/Athens"
  locale       String?  // e.g., "el-GR"
  settingsJson Json?    // rules settings, etc.

  contacts Contact[]
  events   Event[]
  messages Message[]
  jobs     Job[]
  discounts Discount[]
  auditLogs AuditLog[]
  backInStockInterests BackInStockInterest[]
  shortlinks Shortlink[]
  segments Segment[]
  campaignRecipients CampaignRecipient[]
  campaigns Campaign[]
  
  // New relations for discount pooling and automations
  discountCodePools DiscountCodePool[]
  discountCodes DiscountCode[]
  discountCodeReservations DiscountCodeReservation[]
  automations Automation[]
  abandonedCheckouts AbandonedCheckout[]
}

model Contact {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  shop      Shop     @relation(fields: [shopId], references: [id])
  shopId    String

  customerId String? // Shopify Customer GID or numeric string (we keep as text)
  phoneE164  String // normalized E.164 phone (deprecated - use phone_ciphertext)
  firstName  String?
  lastName   String?
  email      String? // deprecated - use email_ciphertext
  
  // PII encryption fields
  phone_hash         String?  @map("phone_hash")         // SHA256 hash for lookup
  phone_ciphertext   String?  @map("phone_ciphertext")   // AES-256-GCM encrypted phone
  phone_last4        String?  @map("phone_last4")         // Last 4 digits for UX
  email_hash         String?  @map("email_hash")         // SHA256 hash for lookup
  email_ciphertext   String?  @map("email_ciphertext")    // AES-256-GCM encrypted email
  
  optedOut   Boolean @default(false)
  // Sprint A: Consent + auditing fields
  smsConsentState  String   @default("unknown") // "opted_in" | "opted_out" | "unknown"
  smsConsentSource String?  // "checkout" | "thank_you" | "banner" | "inbound_stop" | "manual" | "gdpr"
  smsConsentAt     DateTime?
  unsubscribedAt   DateTime?
  tagsJson         Json?
  // Sprint D: mark welcome sent once
  welcomedAt       DateTime?

  // Gender, age, and conversion tracking
  gender           Gender   @default(unknown)
  birthdate        DateTime?
  ageYears         Int?
  conversionCount  Int      @default(0)
  lastConvertedAt  DateTime?
  conversionLtvCents Int    @default(0)

  Message    Message[]
  backInStockInterests BackInStockInterest[]
  campaignRecipients CampaignRecipient[]

  @@unique([shopId, customerId])
  @@unique([shopId, phoneE164], name: "shopId_phoneE164")
  @@index([shopId, phoneE164])
  @@index([shopId, email])
  @@index([shopId, phone_hash])
  @@index([shopId, email_hash])
  @@index([shopId, gender])
  @@index([shopId, ageYears])
  @@index([shopId, lastConvertedAt])
}

model Event {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  shop      Shop     @relation(fields: [shopId], references: [id])
  shopId    String
  topic     String
  objectId  String?
  raw       Json
  dedupeKey String   @unique
  
  // New fields for webhook processing
  idempotencyKey String?  // For webhook deduplication
  checkoutToken  String?  // For abandoned checkout tracking
  orderId        String?  // For order-related events
  hmacHeader     String?  // HMAC signature for verification

  @@index([shopId, topic])
  @@index([shopId, idempotencyKey])
  @@index([shopId, checkoutToken])
  @@index([shopId, orderId])
}

model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  shop      Shop     @relation(fields: [shopId], references: [id])
  shopId    String

  contact   Contact? @relation(fields: [contactId], references: [id])
  contactId String?

  body     String
  provider String // mitto
  status   String // queued, sent, delivered, failed
  metadata Json?
  // Sprint B: categorize messages so rules can filter quickly
  kind      String  @default("automation") // automation|campaign|system
  triggerKey String?

  // Message delivery timestamps
  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  failedAt    DateTime? @map("failed_at")
  
  // New fields for discount and link tracking
  discountCodeId String?
  shortlinkId    String?
  utmJson        Json?

  @@index([shopId, contactId])
  @@index([shopId, contactId, triggerKey])
  @@index([shopId, status, sentAt])
  @@index([shopId, sentAt])
  @@index([shopId, discountCodeId])
  @@index([shopId, shortlinkId])
}

model Job {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  shop       Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId     String

  type       String   @default("abandoned_checkout") // 'abandoned_checkout'
  status     String   @default("pending") // pending|running|done|canceled|failed
  runAt      DateTime
  attempts   Int      @default(0)
  lastError  String?
  payload    Json
  dedupeKey  String?  @unique

  @@index([shopId, status, runAt])
}

model Discount {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId          String

  code            String
  title           String?
  type            String            // 'percentage' | 'amount' | 'shipping'
  value           Decimal? @db.Decimal(10,2)
  currencyCode    String?
  startsAt        DateTime?
  endsAt          DateTime?
  usageLimit      Int?
  oncePerCustomer Boolean? @default(true)
  applyUrl        String?
  providerId      String?          // Shopify CodeDiscountNode id or code handle
  status          String?          // active|expired|scheduled
  utmJson         Json?
  
  // New fields for discount pooling
  mode            String   @default("shared") // 'shared' | 'pool' | 'external'
  shopifyGid      String?  // Shopify discount GID
  combinesWith    Json?    // Shopify combinesWith settings
  
  // Relations
  pool            DiscountCodePool?
  poolId          String?
  codes           DiscountCode[]

  @@index([shopId, code])
  @@index([shopId, mode])
  @@index([shopId, poolId])
}

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  shop      Shop     @relation(fields: [shopId], references: [id])
  shopId    String

  actor     String   // "system" | "user" | "webhook"
  action    String   // e.g. "consent.update", "consent.unsubscribe", "gdpr.data_request", "gdpr.redact"
  entity    String   // "contact" | "shop" | "message" | ...
  entityId  String?  // contact id, etc.
  ip        String?
  ua        String?
  diffJson  Json?

  @@index([shopId, createdAt])
}

model BackInStockInterest {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId          String
  contact         Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId       String
  // We key by InventoryItem ID (numeric) from webhooks for simplicity
  inventoryItemId String
  variantId       String?
  productHandle   String?
  lastNotifiedAt  DateTime?

  @@unique([shopId, contactId, inventoryItemId])
  @@index([shopId, inventoryItemId])
}

model Segment {
  id                 String   @id @default(cuid())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  shop               Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId             String
  name               String
  filterJson         Json     // DSL like {and:[{consent:'opted_in'},{tags:{has:'vip'}}]}
  lastMaterializedAt DateTime?
  isSystem           Boolean  @default(false)
  slug               String?  @unique

  @@index([shopId, updatedAt])
}

model CampaignRecipient {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId      String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId  String
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId   String
  status      String   @default("pending") // pending|sent|failed|skipped
  reason      String?
  messageId   String?
  cost        Decimal? @db.Decimal(10,4)
  segmentsUsed Int?

  @@index([shopId, campaignId, status])
  @@unique([campaignId, contactId])
}

model Shortlink {
  slug        String   @id
  createdAt   DateTime @default(now())
  shop        Shop?    @relation(fields: [shopId], references: [id], onDelete: SetNull)
  shopId      String?
  url         String
  campaignId  String?
  clicks      Int      @default(0)
  expiresAt   DateTime?
}

model Campaign {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId      String
  name        String
  segmentId   String?
  templateId  String?
  templateKey String?
  scheduleAt  DateTime?
  status      String   @default("draft")
  utmJson     Json?
  batchSize   Int?
  bodyText    String?
  discountId  String?                                 // <—— Sprint F
  
  // New discount configuration
  discountConfig Json?  // { mode, discountId, codeStrategy, redirectPath }
  
  // Relations
  recipients CampaignRecipient[]
  discountCodeReservations DiscountCodeReservation[]
  
  // add an index for fast lookups
  @@index([shopId, status, scheduleAt])
}

// New models for discount pooling and automations
model DiscountCodePool {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId      String
  discount    Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  discountId  String   @unique
  
  name        String
  description String?
  totalCodes  Int      @default(0)
  reservedCodes Int    @default(0)
  usedCodes   Int      @default(0)
  status      String   @default("active") // active|inactive|exhausted
  
  // Relations
  codes       DiscountCode[]
  reservations DiscountCodeReservation[]
  
  @@unique([shopId, discountId])
  @@index([shopId, status])
}

model DiscountCode {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId      String
  pool        DiscountCodePool @relation(fields: [poolId], references: [id], onDelete: Cascade)
  poolId      String
  discount    Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)
  discountId  String
  
  code        String
  status      String   @default("available") // available|reserved|used|expired
  reservedAt  DateTime?
  usedAt      DateTime?
  assignedTo  String?  // CampaignRecipient ID when assigned
  shopifyGid  String?  // Shopify discount code GID
  
  // Relations
  reservation DiscountCodeReservation? @relation(fields: [reservationId], references: [id])
  reservationId String?
  
  @@unique([poolId, code])
  @@index([shopId, status])
  @@index([shopId, assignedTo])
  @@index([shopId, poolId, status])
}

model DiscountCodeReservation {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId      String
  pool        DiscountCodePool @relation(fields: [poolId], references: [id], onDelete: Cascade)
  poolId      String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId  String
  
  quantity    Int
  status      String   @default("active") // active|used|expired|cancelled
  expiresAt   DateTime?
  
  // Relations
  codes       DiscountCode[]
  
  @@index([shopId, campaignId])
  @@index([shopId, poolId])
  @@index([shopId, status, expiresAt])
}

model Automation {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId      String
  
  name        String
  trigger     String   // abandoned_checkout|order_created|order_paid|fulfillment_update
  enabled     Boolean  @default(true)
  delayMinutes Int     @default(0)
  template    String
  conditions  Json?    // Additional trigger conditions
  discountConfig Json? // Discount configuration for this automation
  
  @@index([shopId, trigger, enabled])
  @@index([shopId, enabled])
}

model AbandonedCheckout {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId      String
  
  checkoutToken String @unique
  customerId   String?
  email        String?
  phone        String?
  totalPrice   Decimal? @db.Decimal(10,2)
  currency     String?
  abandonedAt  DateTime
  recoveredAt  DateTime?
  abandonedCheckoutUrl String?
  
  @@index([shopId, checkoutToken])
  @@index([shopId, customerId])
  @@index([shopId, abandonedAt])
}
